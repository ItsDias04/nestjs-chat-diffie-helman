# Карта активов и потоков данных

## 1. Инвентаризация активов

### 1.1 Информационные активы

#### Критические данные (уровень критичности: КРИТИЧЕСКИЙ)
| ID | Актив | Описание | Местонахождение | Владелец | Конфиденциальность |
|----|-------|----------|-----------------|----------|-------------------|
| ИА-01 | Учетные данные пользователей | Логины, хеши паролей | БД (таблица users) | DBA | ВЫСОКАЯ |
| ИА-02 | Персональные данные | ФИО, email, телефон | БД (таблица users) | DBA | ВЫСОКАЯ (152-ФЗ) |
| ИА-03 | Криптографические ключи | Приватные ключи DH | БД / Session Storage | Пользователь | КРИТИЧЕСКАЯ |
| ИА-04 | Содержимое сообщений | Текст зашифрованных сообщений | БД (таблица messages) | Пользователь | ВЫСОКАЯ |
| ИА-05 | JWT токены доступа | Access и Refresh токены | Cookies / LocalStorage | Пользователь | ВЫСОКАЯ |

#### Важные данные (уровень критичности: ВЫСОКИЙ)
| ID | Актив | Описание | Местонахождение | Владелец | Конфиденциальность |
|----|-------|----------|-----------------|----------|-------------------|
| ИА-06 | Метаданные сообщений | Время, отправитель, получатель | БД (таблица messages) | Система | СРЕДНЯЯ |
| ИА-07 | Данные о чатах | Список участников, настройки | БД (таблица chats) | Система | СРЕДНЯЯ |
| ИА-08 | История приглашений | Кто кого пригласил, статус | БД (таблица invites) | Система | НИЗКАЯ |
| ИА-09 | Логи системы | Логи аутентификации, действий | Файловая система / ELK | Администратор | СРЕДНЯЯ |
| ИА-10 | Конфигурационные файлы | .env, config.json, secrets | Сервер / Git (!) | DevOps | ВЫСОКАЯ |

### 1.2 Программные активы

| ID | Актив | Технология | Версия | Критичность | Уязвимости |
|----|-------|-----------|---------|-------------|-----------|
| ПА-01 | Backend API | NestJS + TypeScript | ~10.x | КРИТИЧЕСКАЯ | CVE зависимостей |
| ПА-02 | Web Client | Angular | ~18.x | ВЫСОКАЯ | XSS, CSRF |
| ПА-03 | Mobile Client | NativeScript + Angular | ~8.x | ВЫСОКАЯ | Insecure Storage |
| ПА-04 | База данных | PostgreSQL / MySQL | ? | КРИТИЧЕСКАЯ | SQL-инъекции |
| ПА-05 | WebSocket Gateway | Socket.io / WS | ? | ВЫСОКАЯ | DoS |
| ПА-06 | ORM | TypeORM / Prisma | ? | ВЫСОКАЯ | Неправильное использование |

### 1.3 Аппаратные активы

| ID | Актив | Описание | Критичность | Меры защиты |
|----|-------|----------|-------------|-------------|
| АА-01 | Веб-сервер (backend) | Сервер NestJS (порт 3000) | КРИТИЧЕСКАЯ | Firewall, HTTPS |
| АА-02 | Сервер БД | PostgreSQL/MySQL сервер | КРИТИЧЕСКАЯ | Сетевая изоляция |
| АА-03 | Файловый сервер | Хранение логов, резервных копий | ВЫСОКАЯ | Шифрование дисков |
| АА-04 | Клиентские устройства | ПК, смартфоны пользователей | СРЕДНЯЯ | Антивирус, обновления |

### 1.4 Сетевые активы

| ID | Актив | Описание | Критичность | Меры защиты |
|----|-------|----------|-------------|-------------|
| СА-01 | Интернет-канал | Подключение к сети | ВЫСОКАЯ | DDoS-защита |
| СА-02 | Внутренняя сеть | LAN между серверами | ВЫСОКАЯ | VLAN, Firewall |
| СА-03 | VPN (если есть) | Удаленный доступ администраторов | ВЫСОКАЯ | 2FA, логирование |
| СА-04 | DNS | Доменное имя сервиса | СРЕДНЯЯ | DNSSEC |

---

## 2. Потоки данных (Data Flow Diagram)

### 2.1 Процесс регистрации

```
[Пользователь]
    |
    | 1. POST /auth/register
    | Данные: { username, email, password }
    ↓
[Web/Mobile Client]
    |
    | 2. HTTPS Request
    | Валидация на клиенте
    ↓
[NestJS Backend - AuthController]
    |
    | 3. Валидация DTO
    | RegisterDto: class-validator
    ↓
[AuthService]
    |
    | 4. Проверка существования пользователя
    | 5. Хеширование пароля (bcrypt)
    ↓
[База данных]
    |
    | 6. INSERT INTO users
    | Хранение: username, email, passwordHash
    ↓
[AuthService]
    |
    | 7. Генерация JWT токена
    | Payload: { userId, username }
    ↓
[NestJS Backend]
    |
    | 8. HTTPS Response
    | { accessToken, user: {...} }
    ↓
[Web/Mobile Client]
    |
    | 9. Сохранение токена
    | localStorage / HttpOnly Cookie
    ↓
[Пользователь]
```

**Критические зоны**:
- ❌ **Точка 3**: Валидация DTO - возможность SQL-инъекции, XSS
- ❌ **Точка 5**: Сила хеширования (bcrypt rounds)
- ❌ **Точка 9**: Небезопасное хранение токена (localStorage)

---

### 2.2 Процесс аутентификации

```
[Пользователь]
    | Ввод: username/email, password
    ↓
[Client]
    | POST /auth/login
    | { username, password }
    ↓
[AuthController]
    | Валидация LoginDto
    ↓
[AuthService]
    | findByUsername(username)
    ↓
[База данных]
    | SELECT * FROM users WHERE username = ?
    ↓
[AuthService]
    | bcrypt.compare(password, user.passwordHash)
    | Если успешно → генерация JWT
    | Если неуспешно → счетчик попыток
    ↓
[Client]
    | Сохранение JWT
    ↓
[Пользователь] ✓ Аутентифицирован
```

**Критические зоны**:
- ❌ **Точка SQL**: Возможность SQL-инъекции если используется raw query
- ❌ **Нет rate limiting**: Возможность брутфорса
- ❌ **Нет блокировки**: После N неудачных попыток аккаунт не блокируется

---

### 2.3 Процесс обмена ключами Диффи-Хеллмана

```
[Пользователь A]
    | 1. Генерация приватного ключа a
    | 2. Вычисление публичного A = g^a mod p
    ↓
[Client A]
    | POST /diffie-hellman/exchange
    | { publicKey: A, recipientId }
    ↓
[DiffieHellmanController]
    | Валидация параметров
    ↓
[База данных]
    | INSERT INTO dh_keys (userId, publicKey)
    ↓
[WebSocket Gateway]
    | Уведомление пользователя B
    | event: 'key-exchange'
    ↓
[Client B]
    | 3. Генерация приватного ключа b
    | 4. Вычисление публичного B = g^b mod p
    | 5. Вычисление общего ключа K = A^b mod p
    ↓
[Client B отправляет B пользователю A]
    ↓
[Client A]
    | 6. Вычисление общего ключа K = B^a mod p
    ↓
[Оба клиента имеют общий секретный ключ K]
    | Используется для AES шифрования сообщений
```

**Критические зоны**:
- ❌ **Параметры DH**: Использование слабых p, g (должно быть p ≥ 2048 бит)
- ❌ **Генератор случайных чисел**: Небезопасный PRNG
- ❌ **Отсутствие аутентификации**: Возможность MITM-атаки
- ❌ **Хранение ключей**: Приватные ключи не должны покидать клиент

---

### 2.4 Процесс отправки сообщения

```
[Пользователь A]
    | Ввод текста сообщения
    ↓
[Client A]
    | 1. Шифрование AES(message, K)
    | K - общий ключ DH
    ↓
[WebSocket / REST API]
    | POST /messages
    | { chatId, encryptedContent, recipientId }
    ↓
[MessageController]
    | 2. Проверка прав доступа
    | Является ли пользователь участником чата?
    ↓
[База данных]
    | 3. INSERT INTO messages
    | (chatId, senderId, encryptedContent, timestamp)
    ↓
[WebSocket Gateway]
    | 4. Уведомление получателя B
    | event: 'new-message'
    ↓
[Client B]
    | 5. Получение зашифрованного сообщения
    | 6. Расшифровка AES.decrypt(encryptedContent, K)
    ↓
[Пользователь B]
    | Отображение сообщения
```

**Критические зоны**:
- ❌ **Точка 2**: IDOR - проверка владельца ресурса
- ❌ **Точка 3**: XSS при выводе сообщения (если не санитизировано)
- ❌ **Хранение**: Хранятся ли сообщения в зашифрованном виде в БД?
- ❌ **Целостность**: Отсутствие HMAC для проверки целостности

---

## 3. Архитектурная диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│                     Internet / Клиенты                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Web Browser │  │   Mobile    │  │   Tablet    │         │
│  │  (Angular)  │  │(NativeScript)│  │  (Angular)  │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
└─────────┼─────────────────┼─────────────────┼───────────────┘
          │                 │                 │
          │   HTTPS (443)   │   HTTPS (443)   │
          │   WebSocket     │   WebSocket     │
          ↓                 ↓                 ↓
┌─────────────────────────────────────────────────────────────┐
│                     Firewall / WAF                          │
│            (рекомендуется: CloudFlare, ModSecurity)         │
└─────────────────────────────────────────────────────────────┘
          │
          ↓
┌─────────────────────────────────────────────────────────────┐
│                   NestJS Backend Server                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Controllers Layer                                   │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────────────┐     │   │
│  │  │  Auth    │ │ Message  │ │ DiffieHellman    │     │   │
│  │  │Controller│ │Controller│ │ Controller       │     │   │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────────────┘     │   │
│  └───────┼────────────┼─────────────┼───────────────────┘   │
│          │            │             │                       │
│  ┌───────┼────────────┼─────────────┼───────────────────┐   │
│  │  Business Logic Layer (Services)                     │   │
│  │  ┌────▼──────┐ ┌──▼───────┐ ┌───▼──────────────┐    │   │
│  │  │AuthService│ │MsgService│ │ DHService        │    │   │
│  │  └────┬──────┘ └────┬─────┘ └───┬──────────────┘    │   │
│  └───────┼─────────────┼────────────┼───────────────────┘   │
│          │             │            │                       │
│  ┌───────┼─────────────┼────────────┼───────────────────┐   │
│  │  Data Access Layer (Repositories / ORM)              │   │
│  │  └─────┬─────────────┬────────────┬──────────────────┘   │
│  │        │             │            │                      │
│  │  ┌─────▼─────────────▼────────────▼──────────────────┐   │
│  │  │            TypeORM / Prisma                       │   │
│  │  └──────────────────┬────────────────────────────────┘   │
│  │                     │                                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  WebSocket Gateway (Socket.io)                       │   │
│  │  - Real-time сообщения                               │   │
│  │  - Уведомления                                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    База данных                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  PostgreSQL / MySQL                                  │   │
│  │  ┌────────┐ ┌─────────┐ ┌─────────┐ ┌───────────┐   │   │
│  │  │ users  │ │messages │ │  chats  │ │   invites │   │   │
│  │  └────────┘ └─────────┘ └─────────┘ └───────────┘   │   │
│  │  ┌────────┐                                          │   │
│  │  │dh_keys │                                          │   │
│  │  └────────┘                                          │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
│  Меры защиты:                                              │
│  - Шифрование на уровне диска (LUKS / BitLocker)          │
│  - Сетевая изоляция (только localhost / VPN)              │
│  - Резервное копирование (3-2-1 rule)                     │
└─────────────────────────────────────────────────────────────┘

```

---

## 4. Критические зоны безопасности

### 4.1 Входные точки (Attack Surface)

| Точка входа | Протокол | Порт | Описание | Уязвимости |
|-------------|----------|------|----------|-----------|
| `/auth/register` | HTTPS | 443 | Регистрация | SQL-инъекции, XSS, CSRF |
| `/auth/login` | HTTPS | 443 | Аутентификация | Брутфорс, SQL-инъекции |
| `/messages` | HTTPS/WS | 443 | Отправка сообщений | XSS, IDOR, спам |
| `/diffie-hellman/exchange` | HTTPS | 443 | Обмен ключами | MITM, слабые параметры |
| `/users/:id` | HTTPS | 443 | Профиль пользователя | IDOR, утечка данных |
| `/chats/:id` | HTTPS | 443 | Управление чатами | IDOR, неавторизованный доступ |
| WebSocket | WSS | 443 | Real-time коммуникация | DoS, flood |

### 4.2 Зоны доверия (Trust Boundaries)

```
┌────────────────────────────────────────────────────┐
│  Недоверенная зона (Untrusted)                    │
│  - Публичный интернет                             │
│  - Клиентские устройства                          │
│  - Браузеры пользователей                         │
└──────────────┬─────────────────────────────────────┘
               │ Firewall / WAF
               │ ● Валидация входных данных
               │ ● Rate limiting
               │ ● IP filtering
               ↓
┌────────────────────────────────────────────────────┐
│  DMZ (Демилитаризованная зона)                    │
│  - Web-сервер NestJS                              │
│  - WebSocket Gateway                              │
│  ● Минимальные привилегии                         │
│  ● Логирование всех запросов                      │
└──────────────┬─────────────────────────────────────┘
               │ Внутренний Firewall
               │ ● Только необходимые порты
               │ ● Аутентификация
               ↓
┌────────────────────────────────────────────────────┐
│  Доверенная зона (Trusted)                        │
│  - База данных                                    │
│  - Файловое хранилище                             │
│  - Системы логирования                            │
│  ● Полная изоляция от интернета                   │
│  ● Доступ только через backend                    │
│  ● Шифрование данных at rest                      │
└────────────────────────────────────────────────────┘
```

---

## 5. Анализ рисков по активам

### 5.1 Матрица критичности активов

| Актив | Конфиденциальность | Целостность | Доступность | Общая критичность |
|-------|-------------------|-------------|-------------|------------------|
| Учетные данные (ИА-01) | 5 | 5 | 4 | **КРИТИЧЕСКАЯ** |
| Персональные данные (ИА-02) | 5 | 4 | 3 | **КРИТИЧЕСКАЯ** |
| Крипто-ключи (ИА-03) | 5 | 5 | 3 | **КРИТИЧЕСКАЯ** |
| Сообщения (ИА-04) | 5 | 4 | 4 | **КРИТИЧЕСКАЯ** |
| JWT токены (ИА-05) | 5 | 5 | 4 | **КРИТИЧЕСКАЯ** |
| Backend API (ПА-01) | 3 | 5 | 5 | **КРИТИЧЕСКАЯ** |
| База данных (ПА-04) | 5 | 5 | 5 | **КРИТИЧЕСКАЯ** |
| Метаданные (ИА-06) | 3 | 3 | 3 | **СРЕДНЯЯ** |
| Логи (ИА-09) | 3 | 4 | 2 | **СРЕДНЯЯ** |

*Шкала: 1 (низкая) - 5 (критическая)*

---

## 6. Рекомендации по защите активов

### 6.1 Защита данных в покое (Data at Rest)

```yaml
База данных:
  - Шифрование всей БД: LUKS (Linux) / BitLocker (Windows)
  - Шифрование отдельных полей: AES-256 для паролей, ключей
  - Маскирование ПДн: хеширование email, телефонов
  - Регулярные резервные копии: 3-2-1 rule
  
Конфигурационные файлы:
  - .env не в Git: добавить в .gitignore
  - Использование secrets manager: HashiCorp Vault, AWS Secrets Manager
  - Шифрование секретов: ansible-vault, git-crypt
  
Логи:
  - Централизованное хранение: ELK Stack, Graylog
  - Ротация логов: 30 дней
  - Удаление чувствительных данных: паролей, токенов
```

### 6.2 Защита данных в движении (Data in Transit)

```yaml
HTTPS:
  - Принудительное перенаправление: HTTP → HTTPS (301)
  - TLS версия: минимум TLS 1.2, рекомендуется TLS 1.3
  - Cipher suites: только сильные (AES-256-GCM, ChaCha20-Poly1305)
  - HSTS: Strict-Transport-Security: max-age=31536000; includeSubDomains
  - Certificate pinning: для мобильного приложения
  
WebSocket Security:
  - Только WSS (WebSocket Secure)
  - Аутентификация: JWT в заголовках
  - Rate limiting: 100 сообщений/минуту на пользователя
```

### 6.3 Защита на уровне приложения

```yaml
Валидация входных данных:
  - Whitelist подход: только разрешенные символы
  - Санитизация HTML: DOMPurify, sanitize-html
  - Ограничение длины: max 1000 символов для сообщений
  - Проверка типов: class-validator, Joi
  
Аутентификация и авторизация:
  - Политика паролей: минимум 8 символов, сложность
  - MFA: TOTP (Google Authenticator)
  - JWT:
    - Access token: 15 минут
    - Refresh token: 7 дней, rotation
    - HttpOnly cookies для веба
  - RBAC: Role-Based Access Control
  
Rate Limiting:
  - Глобальный: 1000 запросов/час на IP
  - Login: 5 попыток/15 минут
  - Register: 3 регистрации/час на IP
  - Messages: 100 сообщений/минуту
```

---

## 7. План реагирования на инциденты по активам

### 7.1 Компрометация учетных данных

**Индикаторы**:
- Множественные неудачные попытки входа
- Вход с необычного IP/геолокации
- Одновременный вход с разных устройств

**Действия**:
1. Немедленная блокировка аккаунта
2. Аннулирование всех JWT токенов пользователя
3. Отправка email о подозрительной активности
4. Принудительная смена пароля
5. Расследование через логи

### 7.2 Утечка базы данных

**Индикаторы**:
- Необычная активность БД (DUMP запросы)
- Несанкционированный доступ к серверу БД
- Аномальный объем трафика от БД

**Действия**:
1. Немедленное отключение БД от сети
2. Анализ логов доступа
3. Восстановление из резервной копии (если повреждена)
4. Уведомление пользователей (согласно 152-ФЗ, в течение 24ч)
5. Форензика и расследование
6. Смена всех ключей и паролей

### 7.3 DoS/DDoS атака

**Индикаторы**:
- Резкий рост трафика (>10x обычного)
- Высокая нагрузка на CPU/память
- Медленный отклик сервера

**Действия**:
1. Активация CloudFlare DDoS Protection
2. Rate limiting на уровне WAF
3. Блокировка подозрительных IP
4. Масштабирование инфраструктуры (auto-scaling)
5. Связь с ISP для фильтрации на уровне провайдера

---

## 8. Соответствие ISO 27001 и ГОСТ Р 57580

### 8.1 ISO 27001:2022 - Annex A

| Контроль | Требование | Статус | Активы |
|----------|-----------|--------|--------|
| A.5.1 | Политики ИБ | ❌ Отсутствует | Все |
| A.5.10 | Приемлемое использование | ❌ Отсутствует | ИА-05 |
| A.5.12 | Классификация информации | ✅ Выполнено в этом документе | Все ИА |
| A.8.1 | Инвентаризация активов | ✅ Выполнено | Все |
| A.8.2 | Владение активами | ✅ Определено | Все |
| A.8.3 | Приемлемое использование | ❌ Требуется разработка | Все |
| A.8.5 | Безопасное удаление | ⚠️ Частично | ИА-01-05 |
| A.8.10 | Удаление информации | ❌ Нет процедуры | БД, логи |

### 8.2 ГОСТ Р 57580.1-2017

| Раздел | Требование | Статус | Комментарий |
|--------|-----------|--------|-------------|
| 5.2 | Идентификация активов | ✅ Выполнено | Разделы 1.1-1.4 |
| 5.3 | Оценка ценности | ✅ Выполнено | Раздел 5.1 |
| 6.1 | Анализ угроз | ✅ Выполнено | См. 01-threat-research.md |
| 6.2 | Анализ уязвимостей | ⚠️ Частично | Требуется техн. аудит |
| 7.1 | Меры защиты | ⚠️ В процессе | Раздел 6 |

---

## 9. Выводы и рекомендации

### 9.1 Текущее состояние
- ✅ **Идентифицировано**: 10 информационных активов
- ✅ **Определена критичность**: 7 критических активов
- ❌ **Не защищены**: конфигурационные файлы (.env в Git)
- ❌ **Нет шифрования**: сообщения в БД, персональные данные
- ❌ **Отсутствует**: централизованное логирование и мониторинг

### 9.2 Приоритетные меры

**Немедленно (1-3 дня)**:
1. Удалить .env из Git, добавить в .gitignore
2. Включить HTTPS Strict Mode (HSTS)
3. Настроить rate limiting на критичные endpoints

**Краткосрочные (1-2 недели)**:
1. Шифрование персональных данных в БД (AES-256)
2. Внедрение централизованного логирования (ELK)
3. Настройка резервного копирования БД

**Среднесрочные (3-4 недели)**:
1. Внедрение WAF (ModSecurity)
2. Система мониторинга (Wazuh / Zabbix)
3. Аудит и пентест

---

**Дата составления**: 20 ноября 2025  
**Архитектор ИБ**: [Имя]  
**Версия документа**: 1.0  
**Статус**: Утвержден
